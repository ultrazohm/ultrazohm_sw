-- -------------------------------------------------------------
-- 
-- File Name: C:\Users\valen\Documents\repos\UZ\ultrazohm_sw\ip_cores\uz_pmsm_model_9ph\hdl_opti\hdlsrc\uz_pmsm_model_9ph\uz_pmsm_model_9ph_opti_src_Transformation1_MAC_block5.vhd
-- Created: 2022-05-03 11:23:59
-- 
-- Generated by MATLAB 9.10 and HDL Coder 3.18
-- 
-- -------------------------------------------------------------


-- -------------------------------------------------------------
-- 
-- Module: uz_pmsm_model_9ph_opti_src_Transformation1_MAC_block5
-- Source Path: 
-- Hierarchy Level: 2
-- 
-- -------------------------------------------------------------
LIBRARY IEEE;
USE IEEE.std_logic_1164.ALL;
USE IEEE.numeric_std.ALL;
USE work.uz_pmsm_model_9ph_opti_src_uz_pmsm_model_9ph_pkg.ALL;

ENTITY uz_pmsm_model_9ph_opti_src_Transformation1_MAC_block5 IS
  PORT( clk                               :   IN    std_logic;
        reset                             :   IN    std_logic;
        enb                               :   IN    std_logic;
        in0                               :   IN    vector_of_std_logic_vector18(0 TO 8);  -- sfix18_En16 [9]
        in1                               :   IN    vector_of_std_logic_vector25(0 TO 8);  -- sfix25_En12 [9]
        globalSchedule                    :   IN    std_logic;
        out0                              :   OUT   std_logic_vector(42 DOWNTO 0)  -- sfix43_En28
        );
END uz_pmsm_model_9ph_opti_src_Transformation1_MAC_block5;


ARCHITECTURE rtl OF uz_pmsm_model_9ph_opti_src_Transformation1_MAC_block5 IS

  -- Signals
  SIGNAL enb_gated                        : std_logic;
  SIGNAL t_counterSig                     : unsigned(3 DOWNTO 0);  -- ufix4
  SIGNAL t_reset_sig                      : std_logic;
  SIGNAL t_initial_value                  : signed(42 DOWNTO 0);  -- sfix43_En28
  SIGNAL in0_signed                       : vector_of_signed18(0 TO 8);  -- sfix18_En16 [9]
  SIGNAL t_multiportswitch_out            : signed(17 DOWNTO 0);  -- sfix18_En16
  SIGNAL in1_signed                       : vector_of_signed25(0 TO 8);  -- sfix25_En12 [9]
  SIGNAL t_multiportswitch_out_1          : signed(24 DOWNTO 0);  -- sfix25_En12
  SIGNAL t_multiply_out                   : signed(42 DOWNTO 0);  -- sfix43_En28
  SIGNAL t_multiplyadd_out                : signed(42 DOWNTO 0);  -- sfix43_En28
  SIGNAL t_delay_loop                     : signed(42 DOWNTO 0);  -- sfix43_En28
  SIGNAL t_switch_out                     : signed(42 DOWNTO 0);  -- sfix43_En28
  SIGNAL t_multiplyadd_out_bypass         : signed(42 DOWNTO 0);  -- sfix43_En28
  SIGNAL t_multiplyadd_out_last_value     : signed(42 DOWNTO 0);  -- sfix43_En28

  ATTRIBUTE use_dsp : string;

  ATTRIBUTE use_dsp OF t_multiply_out : SIGNAL IS "yes";

BEGIN
  enb_gated <= globalSchedule AND enb;

  -- Count limited, Unsigned Counter
  --  initial value   = 0
  --  step value      = 1
  --  count to value  = 8
  t_counter_process : PROCESS (clk)
  BEGIN
    IF clk'EVENT AND clk = '1' THEN
      IF reset = '1' THEN
        t_counterSig <= to_unsigned(16#0#, 4);
      ELSIF enb_gated = '1' THEN
        IF t_counterSig >= to_unsigned(16#8#, 4) THEN 
          t_counterSig <= to_unsigned(16#0#, 4);
        ELSE 
          t_counterSig <= t_counterSig + to_unsigned(16#1#, 4);
        END IF;
      END IF;
    END IF;
  END PROCESS t_counter_process;


  
  t_reset_sig <= '1' WHEN t_counterSig /= to_unsigned(16#0#, 4) ELSE
      '0';

  t_initial_value <= to_signed(0, 43);

  outputgen1: FOR k IN 0 TO 8 GENERATE
    in0_signed(k) <= signed(in0(k));
  END GENERATE;

  
  t_multiportswitch_out <= in0_signed(0) WHEN t_counterSig = to_unsigned(16#0#, 4) ELSE
      in0_signed(1) WHEN t_counterSig = to_unsigned(16#1#, 4) ELSE
      in0_signed(2) WHEN t_counterSig = to_unsigned(16#2#, 4) ELSE
      in0_signed(3) WHEN t_counterSig = to_unsigned(16#3#, 4) ELSE
      in0_signed(4) WHEN t_counterSig = to_unsigned(16#4#, 4) ELSE
      in0_signed(5) WHEN t_counterSig = to_unsigned(16#5#, 4) ELSE
      in0_signed(6) WHEN t_counterSig = to_unsigned(16#6#, 4) ELSE
      in0_signed(7) WHEN t_counterSig = to_unsigned(16#7#, 4) ELSE
      in0_signed(8);

  outputgen: FOR k IN 0 TO 8 GENERATE
    in1_signed(k) <= signed(in1(k));
  END GENERATE;

  
  t_multiportswitch_out_1 <= in1_signed(0) WHEN t_counterSig = to_unsigned(16#0#, 4) ELSE
      in1_signed(1) WHEN t_counterSig = to_unsigned(16#1#, 4) ELSE
      in1_signed(2) WHEN t_counterSig = to_unsigned(16#2#, 4) ELSE
      in1_signed(3) WHEN t_counterSig = to_unsigned(16#3#, 4) ELSE
      in1_signed(4) WHEN t_counterSig = to_unsigned(16#4#, 4) ELSE
      in1_signed(5) WHEN t_counterSig = to_unsigned(16#5#, 4) ELSE
      in1_signed(6) WHEN t_counterSig = to_unsigned(16#6#, 4) ELSE
      in1_signed(7) WHEN t_counterSig = to_unsigned(16#7#, 4) ELSE
      in1_signed(8);

  t_multiply_out <= t_multiportswitch_out * t_multiportswitch_out_1;

  t_delay_process : PROCESS (clk)
  BEGIN
    IF clk'EVENT AND clk = '1' THEN
      IF reset = '1' THEN
        t_delay_loop <= to_signed(0, 43);
      ELSIF enb_gated = '1' THEN
        t_delay_loop <= t_multiplyadd_out;
      END IF;
    END IF;
  END PROCESS t_delay_process;


  
  t_switch_out <= t_initial_value WHEN t_reset_sig = '0' ELSE
      t_delay_loop;

  t_multiplyadd_out <= t_switch_out + t_multiply_out;

  out0_bypass_process : PROCESS (clk)
  BEGIN
    IF clk'EVENT AND clk = '1' THEN
      IF reset = '1' THEN
        t_multiplyadd_out_last_value <= to_signed(0, 43);
      ELSIF enb_gated = '1' THEN
        t_multiplyadd_out_last_value <= t_multiplyadd_out_bypass;
      END IF;
    END IF;
  END PROCESS out0_bypass_process;


  
  t_multiplyadd_out_bypass <= t_multiplyadd_out_last_value WHEN globalSchedule = '0' ELSE
      t_multiplyadd_out;

  out0 <= std_logic_vector(t_multiplyadd_out_bypass);

END rtl;

