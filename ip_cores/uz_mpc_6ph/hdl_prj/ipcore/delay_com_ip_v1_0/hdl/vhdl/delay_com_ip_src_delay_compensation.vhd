-- -------------------------------------------------------------
-- 
-- File Name: hdl_prj\hdlsrc\uz_mpc_delay_comp\delay_com_ip_src_delay_compensation.vhd
-- Created: 2022-08-24 12:02:28
-- 
-- Generated by MATLAB 9.10 and HDL Coder 3.18
-- 
-- -------------------------------------------------------------


-- -------------------------------------------------------------
-- 
-- Module: delay_com_ip_src_delay_compensation
-- Source Path: uz_mpc_delay_comp/delay_comp/delay_compensation
-- Hierarchy Level: 1
-- 
-- -------------------------------------------------------------
LIBRARY IEEE;
USE IEEE.std_logic_1164.ALL;
USE IEEE.numeric_std.ALL;

ENTITY delay_com_ip_src_delay_compensation IS
  PORT( clk                               :   IN    std_logic;
        reset                             :   IN    std_logic;
        enb                               :   IN    std_logic;
        vd_pu                             :   IN    std_logic_vector(26 DOWNTO 0);  -- sfix27_En24
        vq_pu                             :   IN    std_logic_vector(26 DOWNTO 0);  -- sfix27_En24
        vx_pu                             :   IN    std_logic_vector(26 DOWNTO 0);  -- sfix27_En24
        vy_pu                             :   IN    std_logic_vector(26 DOWNTO 0);  -- sfix27_En24
        id_k_pu                           :   IN    std_logic_vector(26 DOWNTO 0);  -- sfix27_En16
        iq_k_pu                           :   IN    std_logic_vector(26 DOWNTO 0);  -- sfix27_En16
        ix_k_pu                           :   IN    std_logic_vector(17 DOWNTO 0);  -- sfix18_En11
        iy_k_pu                           :   IN    std_logic_vector(17 DOWNTO 0);  -- sfix18_En11
        omega_m_pu                        :   IN    std_logic_vector(17 DOWNTO 0);  -- sfix18_En15
        Ts_times_ZB_over_Ld               :   IN    std_logic_vector(17 DOWNTO 0);  -- sfix18_En15
        Ts_times_ZB_over_Lq               :   IN    std_logic_vector(17 DOWNTO 0);  -- sfix18_En15
        Ts_times_ZB_over_Lx               :   IN    std_logic_vector(17 DOWNTO 0);  -- sfix18_En15
        Ts_times_ZB_over_Ly               :   IN    std_logic_vector(17 DOWNTO 0);  -- sfix18_En15
        Rs_over_ZB                        :   IN    std_logic_vector(17 DOWNTO 0);  -- sfix18_En15
        Ld_over_LB                        :   IN    std_logic_vector(17 DOWNTO 0);  -- sfix18_En15
        Lq_over_LB                        :   IN    std_logic_vector(17 DOWNTO 0);  -- sfix18_En15
        psi_pm_over_psiB                  :   IN    std_logic_vector(17 DOWNTO 0);  -- sfix18_En15
        polepairs                         :   IN    std_logic_vector(31 DOWNTO 0);  -- uint32
        id_delay_pu                       :   OUT   std_logic_vector(26 DOWNTO 0);  -- sfix27_En24
        iq_delay_pu                       :   OUT   std_logic_vector(26 DOWNTO 0);  -- sfix27_En24
        ix_delay_pu                       :   OUT   std_logic_vector(26 DOWNTO 0);  -- sfix27_En24
        iy_delay_pu                       :   OUT   std_logic_vector(26 DOWNTO 0)  -- sfix27_En24
        );
END delay_com_ip_src_delay_compensation;


ARCHITECTURE rtl OF delay_com_ip_src_delay_compensation IS

  -- Signals
  SIGNAL Rs_over_ZB_signed                : signed(17 DOWNTO 0);  -- sfix18_En15
  SIGNAL id_k_pu_signed                   : signed(26 DOWNTO 0);  -- sfix27_En16
  SIGNAL iq_k_pu_signed                   : signed(26 DOWNTO 0);  -- sfix27_En16
  SIGNAL Lq_over_LB_signed                : signed(17 DOWNTO 0);  -- sfix18_En15
  SIGNAL tmp                              : signed(44 DOWNTO 0);  -- sfix45_En31
  SIGNAL omega_m_pu_signed                : signed(17 DOWNTO 0);  -- sfix18_En15
  SIGNAL tmp_1                            : signed(62 DOWNTO 0);  -- sfix63_En46
  SIGNAL polepairs_unsigned               : unsigned(31 DOWNTO 0);  -- uint32
  SIGNAL tmp_2                            : unsigned(17 DOWNTO 0);  -- ufix18
  SIGNAL Ts_times_ZB_over_Ld_signed       : signed(17 DOWNTO 0);  -- sfix18_En15
  SIGNAL vd_pu_signed                     : signed(26 DOWNTO 0);  -- sfix27_En24
  SIGNAL tmp_3                            : signed(45 DOWNTO 0);  -- sfix46_En31
  SIGNAL tmp_4                            : signed(44 DOWNTO 0);  -- sfix45_En31
  SIGNAL tmp_5                            : signed(45 DOWNTO 0);  -- sfix46_En31
  SIGNAL tmp_buff                         : signed(45 DOWNTO 0);  -- sfix46_En31
  SIGNAL tmp_6                            : signed(81 DOWNTO 0);  -- sfix82_En46
  SIGNAL multiplier_cast                  : signed(18 DOWNTO 0);  -- sfix19
  SIGNAL multiplier_mul_temp              : signed(81 DOWNTO 0);  -- sfix82_En46
  SIGNAL tmp_7                            : signed(80 DOWNTO 0);  -- sfix81_En46
  SIGNAL tmp_8                            : signed(81 DOWNTO 0);  -- sfix82_En46
  SIGNAL tmp_9                            : signed(81 DOWNTO 0);  -- sfix82_En46
  SIGNAL tmp_10                           : signed(99 DOWNTO 0);  -- sfix100_En61
  SIGNAL tmp_11                           : signed(100 DOWNTO 0);  -- sfix101_En61
  SIGNAL tmp_12                           : signed(100 DOWNTO 0);  -- sfix101_En61
  SIGNAL tmp_13                           : signed(100 DOWNTO 0);  -- sfix101_En61
  SIGNAL tmp_14                           : signed(26 DOWNTO 0);  -- sfix27_En24
  SIGNAL tmp_15                           : signed(26 DOWNTO 0);  -- sfix27_En24
  SIGNAL multiplier_cast_1                : signed(18 DOWNTO 0);  -- sfix19
  SIGNAL multiplier_mul_temp_1            : signed(36 DOWNTO 0);  -- sfix37_En15
  SIGNAL tmp_16                           : signed(35 DOWNTO 0);  -- sfix36_En15
  SIGNAL Ld_over_LB_signed                : signed(17 DOWNTO 0);  -- sfix18_En15
  SIGNAL tmp_17                           : signed(53 DOWNTO 0);  -- sfix54_En30
  SIGNAL Ts_times_ZB_over_Lq_signed       : signed(17 DOWNTO 0);  -- sfix18_En15
  SIGNAL vq_pu_signed                     : signed(26 DOWNTO 0);  -- sfix27_En24
  SIGNAL tmp_18                           : signed(45 DOWNTO 0);  -- sfix46_En31
  SIGNAL tmp_19                           : signed(44 DOWNTO 0);  -- sfix45_En31
  SIGNAL tmp_20                           : signed(45 DOWNTO 0);  -- sfix46_En31
  SIGNAL tmp_buff_1                       : signed(45 DOWNTO 0);  -- sfix46_En31
  SIGNAL tmp_21                           : signed(81 DOWNTO 0);  -- sfix82_En46
  SIGNAL tmp_22                           : signed(80 DOWNTO 0);  -- sfix81_En46
  SIGNAL tmp_23                           : signed(81 DOWNTO 0);  -- sfix82_En46
  SIGNAL tmp_buff_2                       : signed(81 DOWNTO 0);  -- sfix82_En46
  SIGNAL tmp_24                           : signed(82 DOWNTO 0);  -- sfix83_En46
  SIGNAL multiplier_cast_2                : signed(18 DOWNTO 0);  -- sfix19
  SIGNAL multiplier_mul_temp_2            : signed(36 DOWNTO 0);  -- sfix37_En15
  SIGNAL tmp_25                           : signed(35 DOWNTO 0);  -- sfix36_En15
  SIGNAL psi_pm_over_psiB_signed          : signed(17 DOWNTO 0);  -- sfix18_En15
  SIGNAL tmp_26                           : signed(53 DOWNTO 0);  -- sfix54_En30
  SIGNAL tmp_27                           : signed(82 DOWNTO 0);  -- sfix83_En46
  SIGNAL tmp_buff_3                       : signed(82 DOWNTO 0);  -- sfix83_En46
  SIGNAL tmp_28                           : signed(100 DOWNTO 0);  -- sfix101_En61
  SIGNAL tmp_29                           : signed(101 DOWNTO 0);  -- sfix102_En61
  SIGNAL tmp_30                           : signed(101 DOWNTO 0);  -- sfix102_En61
  SIGNAL tmp_31                           : signed(101 DOWNTO 0);  -- sfix102_En61
  SIGNAL tmp_32                           : signed(26 DOWNTO 0);  -- sfix27_En24
  SIGNAL iq_delay_pu_tmp                  : signed(26 DOWNTO 0);  -- sfix27_En24
  SIGNAL ix_k_pu_signed                   : signed(17 DOWNTO 0);  -- sfix18_En11
  SIGNAL tmp_33                           : signed(26 DOWNTO 0);  -- sfix27_En16
  SIGNAL Ts_times_ZB_over_Lx_signed       : signed(17 DOWNTO 0);  -- sfix18_En15
  SIGNAL vx_pu_signed                     : signed(26 DOWNTO 0);  -- sfix27_En24
  SIGNAL tmp_34                           : signed(45 DOWNTO 0);  -- sfix46_En31
  SIGNAL tmp_35                           : signed(44 DOWNTO 0);  -- sfix45_En31
  SIGNAL tmp_36                           : signed(45 DOWNTO 0);  -- sfix46_En31
  SIGNAL tmp_buff_4                       : signed(45 DOWNTO 0);  -- sfix46_En31
  SIGNAL tmp_37                           : signed(63 DOWNTO 0);  -- sfix64_En46
  SIGNAL tmp_38                           : signed(64 DOWNTO 0);  -- sfix65_En46
  SIGNAL tmp_39                           : signed(64 DOWNTO 0);  -- sfix65_En46
  SIGNAL tmp_40                           : signed(64 DOWNTO 0);  -- sfix65_En46
  SIGNAL tmp_41                           : signed(26 DOWNTO 0);  -- sfix27_En24
  SIGNAL ix_delay_pu_tmp                  : signed(26 DOWNTO 0);  -- sfix27_En24
  SIGNAL iy_k_pu_signed                   : signed(17 DOWNTO 0);  -- sfix18_En11
  SIGNAL tmp_42                           : signed(26 DOWNTO 0);  -- sfix27_En16
  SIGNAL Ts_times_ZB_over_Ly_signed       : signed(17 DOWNTO 0);  -- sfix18_En15
  SIGNAL vy_pu_signed                     : signed(26 DOWNTO 0);  -- sfix27_En24
  SIGNAL tmp_43                           : signed(45 DOWNTO 0);  -- sfix46_En31
  SIGNAL tmp_44                           : signed(44 DOWNTO 0);  -- sfix45_En31
  SIGNAL tmp_45                           : signed(45 DOWNTO 0);  -- sfix46_En31
  SIGNAL tmp_buff_5                       : signed(45 DOWNTO 0);  -- sfix46_En31
  SIGNAL tmp_46                           : signed(63 DOWNTO 0);  -- sfix64_En46
  SIGNAL tmp_47                           : signed(64 DOWNTO 0);  -- sfix65_En46
  SIGNAL tmp_48                           : signed(64 DOWNTO 0);  -- sfix65_En46
  SIGNAL tmp_49                           : signed(64 DOWNTO 0);  -- sfix65_En46
  SIGNAL tmp_50                           : signed(26 DOWNTO 0);  -- sfix27_En24
  SIGNAL iy_delay_pu_tmp                  : signed(26 DOWNTO 0);  -- sfix27_En24

BEGIN
  Rs_over_ZB_signed <= signed(Rs_over_ZB);

  id_k_pu_signed <= signed(id_k_pu);

  iq_k_pu_signed <= signed(iq_k_pu);

  Lq_over_LB_signed <= signed(Lq_over_LB);

  tmp <= iq_k_pu_signed * Lq_over_LB_signed;

  omega_m_pu_signed <= signed(omega_m_pu);

  tmp_1 <= tmp * omega_m_pu_signed;

  polepairs_unsigned <= unsigned(polepairs);

  tmp_2 <= polepairs_unsigned(17 DOWNTO 0);

  Ts_times_ZB_over_Ld_signed <= signed(Ts_times_ZB_over_Ld);

  -- HDL code generation from MATLAB function: sf_gateway_delay_compensation
  -- MATLAB Function 'delay_comp/delay_compensation'
  vd_pu_signed <= signed(vd_pu);

  tmp_3 <= resize(vd_pu_signed & '0' & '0' & '0' & '0' & '0' & '0' & '0', 46);

  -- pre calculations for d-current
  tmp_4 <= Rs_over_ZB_signed * id_k_pu_signed;

  tmp_5 <= resize(tmp_4, 46);

  tmp_buff <= tmp_3 - tmp_5;

  tmp_6 <= resize(tmp_buff & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0', 82);

  multiplier_cast <= signed(resize(tmp_2, 19));
  multiplier_mul_temp <= tmp_1 * multiplier_cast;
  tmp_7 <= multiplier_mul_temp(80 DOWNTO 0);

  tmp_8 <= resize(tmp_7, 82);

  tmp_9 <= tmp_6 + tmp_8;

  -- Prediction d-current
  tmp_10 <= Ts_times_ZB_over_Ld_signed * tmp_9;

  tmp_11 <= resize(tmp_10, 101);

  tmp_12 <= resize(id_k_pu_signed & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0', 101);

  tmp_13 <= tmp_11 + tmp_12;

  tmp_14 <= tmp_13(63 DOWNTO 37);

  --     iy_delay_pu = coder.hdl.pipeline(fi(Ts_times_ZB_over_Ly *(vy_pu - Rs_over_ZB * iy_k_pu) + iy_k_pu,1,27,24));
  rd_0_process : PROCESS (clk)
  BEGIN
    IF clk'EVENT AND clk = '1' THEN
      IF reset = '1' THEN
        tmp_15 <= to_signed(16#0000000#, 27);
      ELSIF enb = '1' THEN
        tmp_15 <= tmp_14;
      END IF;
    END IF;
  END PROCESS rd_0_process;


  id_delay_pu <= std_logic_vector(tmp_15);

  multiplier_cast_1 <= signed(resize(tmp_2, 19));
  multiplier_mul_temp_1 <= omega_m_pu_signed * multiplier_cast_1;
  tmp_16 <= multiplier_mul_temp_1(35 DOWNTO 0);

  Ld_over_LB_signed <= signed(Ld_over_LB);

  tmp_17 <= tmp_16 * Ld_over_LB_signed;

  Ts_times_ZB_over_Lq_signed <= signed(Ts_times_ZB_over_Lq);

  vq_pu_signed <= signed(vq_pu);

  tmp_18 <= resize(vq_pu_signed & '0' & '0' & '0' & '0' & '0' & '0' & '0', 46);

  -- pre calculations for q-current
  tmp_19 <= Rs_over_ZB_signed * iq_k_pu_signed;

  tmp_20 <= resize(tmp_19, 46);

  tmp_buff_1 <= tmp_18 - tmp_20;

  tmp_21 <= resize(tmp_buff_1 & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0', 82);

  tmp_22 <= tmp_17 * id_k_pu_signed;

  tmp_23 <= resize(tmp_22, 82);

  tmp_buff_2 <= tmp_21 - tmp_23;

  tmp_24 <= resize(tmp_buff_2, 83);

  multiplier_cast_2 <= signed(resize(tmp_2, 19));
  multiplier_mul_temp_2 <= omega_m_pu_signed * multiplier_cast_2;
  tmp_25 <= multiplier_mul_temp_2(35 DOWNTO 0);

  psi_pm_over_psiB_signed <= signed(psi_pm_over_psiB);

  tmp_26 <= tmp_25 * psi_pm_over_psiB_signed;

  tmp_27 <= resize(tmp_26 & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0', 83);

  tmp_buff_3 <= tmp_24 - tmp_27;

  --     id_delay_pu = fi(Ts_times_ZB_over_Ld *(vd_pu - Rs_over_ZB * id_k_pu + iq_k_pu * Lq_over_LB * omega_m_pu * 
  -- polepairs) + id_k_pu,1,27,24)
  -- Prediction q-current
  tmp_28 <= Ts_times_ZB_over_Lq_signed * tmp_buff_3;

  tmp_29 <= resize(tmp_28, 102);

  tmp_30 <= resize(iq_k_pu_signed & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0', 102);

  tmp_31 <= tmp_29 + tmp_30;

  tmp_32 <= tmp_31(63 DOWNTO 37);

  rd_1_process : PROCESS (clk)
  BEGIN
    IF clk'EVENT AND clk = '1' THEN
      IF reset = '1' THEN
        iq_delay_pu_tmp <= to_signed(16#0000000#, 27);
      ELSIF enb = '1' THEN
        iq_delay_pu_tmp <= tmp_32;
      END IF;
    END IF;
  END PROCESS rd_1_process;


  iq_delay_pu <= std_logic_vector(iq_delay_pu_tmp);

  ix_k_pu_signed <= signed(ix_k_pu);

  tmp_33 <= resize(ix_k_pu_signed & '0' & '0' & '0' & '0' & '0', 27);

  Ts_times_ZB_over_Lx_signed <= signed(Ts_times_ZB_over_Lx);

  vx_pu_signed <= signed(vx_pu);

  tmp_34 <= resize(vx_pu_signed & '0' & '0' & '0' & '0' & '0' & '0' & '0', 46);

  -- pre clculations for x-current
  tmp_35 <= Rs_over_ZB_signed * tmp_33;

  tmp_36 <= resize(tmp_35, 46);

  tmp_buff_4 <= tmp_34 - tmp_36;

  --     iq_delay_pu = coder.hdl.pipeline(fi(Ts_times_ZB_over_Lq *(vq_pu - Rs_over_ZB * iq_k_pu - omega_m_pu * polepairs 
  -- * Ld_over_LB * id_k_pu - omega_m_pu * polepairs * psi_pm_over_psiB) + iq_k_pu,1,27,24))
  -- Prediction x-current
  tmp_37 <= Ts_times_ZB_over_Lx_signed * tmp_buff_4;

  tmp_38 <= resize(tmp_37, 65);

  tmp_39 <= resize(tmp_33 & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0', 65);

  tmp_40 <= tmp_38 + tmp_39;

  tmp_41 <= tmp_40(48 DOWNTO 22);

  rd_3_process : PROCESS (clk)
  BEGIN
    IF clk'EVENT AND clk = '1' THEN
      IF reset = '1' THEN
        ix_delay_pu_tmp <= to_signed(16#0000000#, 27);
      ELSIF enb = '1' THEN
        ix_delay_pu_tmp <= tmp_41;
      END IF;
    END IF;
  END PROCESS rd_3_process;


  ix_delay_pu <= std_logic_vector(ix_delay_pu_tmp);

  iy_k_pu_signed <= signed(iy_k_pu);

  tmp_42 <= resize(iy_k_pu_signed & '0' & '0' & '0' & '0' & '0', 27);

  Ts_times_ZB_over_Ly_signed <= signed(Ts_times_ZB_over_Ly);

  vy_pu_signed <= signed(vy_pu);

  tmp_43 <= resize(vy_pu_signed & '0' & '0' & '0' & '0' & '0' & '0' & '0', 46);

  -- pre clculations for y-current
  tmp_44 <= Rs_over_ZB_signed * tmp_42;

  tmp_45 <= resize(tmp_44, 46);

  tmp_buff_5 <= tmp_43 - tmp_45;

  --     ix_delay_pu = coder.hdl.pipeline(fi(Ts_times_ZB_over_Lx *(vx_pu - Rs_over_ZB* ix_k_pu) + ix_k_pu,1,27,24));
  -- Prediction y-current
  tmp_46 <= Ts_times_ZB_over_Ly_signed * tmp_buff_5;

  tmp_47 <= resize(tmp_46, 65);

  tmp_48 <= resize(tmp_42 & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0', 65);

  tmp_49 <= tmp_47 + tmp_48;

  tmp_50 <= tmp_49(48 DOWNTO 22);

  rd_2_process : PROCESS (clk)
  BEGIN
    IF clk'EVENT AND clk = '1' THEN
      IF reset = '1' THEN
        iy_delay_pu_tmp <= to_signed(16#0000000#, 27);
      ELSIF enb = '1' THEN
        iy_delay_pu_tmp <= tmp_50;
      END IF;
    END IF;
  END PROCESS rd_2_process;


  iy_delay_pu <= std_logic_vector(iy_delay_pu_tmp);

END rtl;

