-- -------------------------------------------------------------
-- 
-- File Name: hdl_prj\hdlsrc\inc_enc_v26\Incremental_Encoder_v26_src_Average.vhd
-- Created: 2023-03-06 13:40:26
-- 
-- Generated by MATLAB 9.13 and HDL Coder 4.0
-- 
-- -------------------------------------------------------------


-- -------------------------------------------------------------
-- 
-- Module: Incremental_Encoder_v26_src_Average
-- Source Path: inc_enc_v26/IncEnc_V25/speed/Average
-- Hierarchy Level: 2
-- 
-- -------------------------------------------------------------
LIBRARY IEEE;
USE IEEE.std_logic_1164.ALL;
USE IEEE.numeric_std.ALL;
USE work.Incremental_Encoder_v26_src_IncEnc_V25_pac.ALL;

ENTITY Incremental_Encoder_v26_src_Average IS
  PORT( clk                               :   IN    std_logic;
        reset_x                           :   IN    std_logic;
        enb_1_5987_0                      :   IN    std_logic;
        OmegaIn                           :   IN    vector_of_std_logic_vector24(0 TO 3);  -- sfix24_En11 [4]
        NewMeasurement                    :   IN    std_logic;
        Omega                             :   OUT   std_logic_vector(23 DOWNTO 0);  -- sfix24_En11
        OmegaOut_MA_N4                    :   OUT   std_logic_vector(23 DOWNTO 0)  -- sfix24_En11
        );
END Incremental_Encoder_v26_src_Average;


ARCHITECTURE rtl OF Incremental_Encoder_v26_src_Average IS

  -- Signals
  SIGNAL x_k_0                            : signed(23 DOWNTO 0);  -- sfix24_En11
  SIGNAL x_k_1                            : signed(23 DOWNTO 0);  -- sfix24_En11
  SIGNAL Sum_of_Elements4_add_cast        : signed(24 DOWNTO 0);  -- sfix25_En11
  SIGNAL Sum_of_Elements4_add_cast_1      : signed(24 DOWNTO 0);  -- sfix25_En11
  SIGNAL Sum_of_Elements4_out1            : signed(24 DOWNTO 0);  -- sfix25_En11
  SIGNAL x_k_2                            : signed(23 DOWNTO 0);  -- sfix24_En11
  SIGNAL x_k_3                            : signed(23 DOWNTO 0);  -- sfix24_En11
  SIGNAL Sum_of_Elements5_add_cast        : signed(24 DOWNTO 0);  -- sfix25_En11
  SIGNAL Sum_of_Elements5_add_cast_1      : signed(24 DOWNTO 0);  -- sfix25_En11
  SIGNAL Sum_of_Elements5_out1            : signed(24 DOWNTO 0);  -- sfix25_En11
  SIGNAL Sum_of_Elements6_add_cast        : signed(25 DOWNTO 0);  -- sfix26_En11
  SIGNAL Sum_of_Elements6_add_cast_1      : signed(25 DOWNTO 0);  -- sfix26_En11
  SIGNAL Sum_of_Elements6_out1            : signed(25 DOWNTO 0);  -- sfix26_En11
  SIGNAL Gain1_cast                       : signed(51 DOWNTO 0);  -- sfix52_En37
  SIGNAL omega_summed_1_4                 : signed(23 DOWNTO 0);  -- sfix24_En11
  SIGNAL x_k                              : signed(23 DOWNTO 0);  -- sfix24_En11
  SIGNAL x_k_1delayed                     : signed(23 DOWNTO 0);  -- sfix24_En11
  SIGNAL enable_delayed                   : std_logic;
  SIGNAL omega_delay1                     : signed(23 DOWNTO 0);  -- sfix24_En11
  SIGNAL Sum_of_Elements1_add_cast        : signed(24 DOWNTO 0);  -- sfix25_En11
  SIGNAL Sum_of_Elements1_add_cast_1      : signed(24 DOWNTO 0);  -- sfix25_En11
  SIGNAL Sum_of_Elements1_out1            : signed(24 DOWNTO 0);  -- sfix25_En11
  SIGNAL omega_delay2                     : signed(23 DOWNTO 0);  -- sfix24_En11
  SIGNAL omega_delay3                     : signed(23 DOWNTO 0);  -- sfix24_En11
  SIGNAL Sum_of_Elements2_add_cast        : signed(24 DOWNTO 0);  -- sfix25_En11
  SIGNAL Sum_of_Elements2_add_cast_1      : signed(24 DOWNTO 0);  -- sfix25_En11
  SIGNAL Sum_of_Elements2_out1            : signed(24 DOWNTO 0);  -- sfix25_En11
  SIGNAL Sum_of_Elements3_add_cast        : signed(25 DOWNTO 0);  -- sfix26_En11
  SIGNAL Sum_of_Elements3_add_cast_1      : signed(25 DOWNTO 0);  -- sfix26_En11
  SIGNAL Sum_of_Elements3_out1            : signed(25 DOWNTO 0);  -- sfix26_En11
  SIGNAL Gain_cast                        : signed(51 DOWNTO 0);  -- sfix52_En37
  SIGNAL omega_moving_average             : signed(23 DOWNTO 0);  -- sfix24_En11

BEGIN
  -- average 4 parallel measurements
  -- moving average of 4 last measurements, which in total results in a moving average of the last 8 samples

  x_k_0 <= signed(OmegaIn(0));

  x_k_1 <= signed(OmegaIn(1));

  Sum_of_Elements4_add_cast <= resize(x_k_0, 25);
  Sum_of_Elements4_add_cast_1 <= resize(x_k_1, 25);
  Sum_of_Elements4_out1 <= Sum_of_Elements4_add_cast + Sum_of_Elements4_add_cast_1;

  x_k_2 <= signed(OmegaIn(2));

  x_k_3 <= signed(OmegaIn(3));

  Sum_of_Elements5_add_cast <= resize(x_k_2, 25);
  Sum_of_Elements5_add_cast_1 <= resize(x_k_3, 25);
  Sum_of_Elements5_out1 <= Sum_of_Elements5_add_cast + Sum_of_Elements5_add_cast_1;

  Sum_of_Elements6_add_cast <= resize(Sum_of_Elements4_out1, 26);
  Sum_of_Elements6_add_cast_1 <= resize(Sum_of_Elements5_out1, 26);
  Sum_of_Elements6_out1 <= Sum_of_Elements6_add_cast + Sum_of_Elements6_add_cast_1;

  Gain1_cast <= resize(Sum_of_Elements6_out1 & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0', 52);
  omega_summed_1_4 <= Gain1_cast(49 DOWNTO 26);

  DelayToCompensate_sum_process : PROCESS (clk)
  BEGIN
    IF clk'EVENT AND clk = '1' THEN
      IF reset_x = '1' THEN
        x_k <= to_signed(16#000000#, 24);
      ELSIF enb_1_5987_0 = '1' THEN
        x_k <= omega_summed_1_4;
      END IF;
    END IF;
  END PROCESS DelayToCompensate_sum_process;


  Omega <= std_logic_vector(x_k);

  delay1_process : PROCESS (clk)
  BEGIN
    IF clk'EVENT AND clk = '1' THEN
      IF reset_x = '1' THEN
        x_k_1delayed <= to_signed(16#000000#, 24);
      ELSIF enb_1_5987_0 = '1' THEN
        x_k_1delayed <= x_k;
      END IF;
    END IF;
  END PROCESS delay1_process;


  delay_process : PROCESS (clk)
  BEGIN
    IF clk'EVENT AND clk = '1' THEN
      IF reset_x = '1' THEN
        enable_delayed <= '0';
      ELSIF enb_1_5987_0 = '1' THEN
        enable_delayed <= NewMeasurement;
      END IF;
    END IF;
  END PROCESS delay_process;


  Unit_Delay_Enabled_Synchronous_process : PROCESS (clk)
  BEGIN
    IF clk'EVENT AND clk = '1' THEN
      IF reset_x = '1' THEN
        omega_delay1 <= to_signed(16#000000#, 24);
      ELSIF enb_1_5987_0 = '1' AND enable_delayed = '1' THEN
        omega_delay1 <= x_k;
      END IF;
    END IF;
  END PROCESS Unit_Delay_Enabled_Synchronous_process;


  Sum_of_Elements1_add_cast <= resize(x_k_1delayed, 25);
  Sum_of_Elements1_add_cast_1 <= resize(omega_delay1, 25);
  Sum_of_Elements1_out1 <= Sum_of_Elements1_add_cast + Sum_of_Elements1_add_cast_1;

  Unit_Delay_Enabled_Synchronous1_process : PROCESS (clk)
  BEGIN
    IF clk'EVENT AND clk = '1' THEN
      IF reset_x = '1' THEN
        omega_delay2 <= to_signed(16#000000#, 24);
      ELSIF enb_1_5987_0 = '1' AND enable_delayed = '1' THEN
        omega_delay2 <= omega_delay1;
      END IF;
    END IF;
  END PROCESS Unit_Delay_Enabled_Synchronous1_process;


  Unit_Delay_Enabled_Synchronous2_process : PROCESS (clk)
  BEGIN
    IF clk'EVENT AND clk = '1' THEN
      IF reset_x = '1' THEN
        omega_delay3 <= to_signed(16#000000#, 24);
      ELSIF enb_1_5987_0 = '1' AND enable_delayed = '1' THEN
        omega_delay3 <= omega_delay2;
      END IF;
    END IF;
  END PROCESS Unit_Delay_Enabled_Synchronous2_process;


  Sum_of_Elements2_add_cast <= resize(omega_delay2, 25);
  Sum_of_Elements2_add_cast_1 <= resize(omega_delay3, 25);
  Sum_of_Elements2_out1 <= Sum_of_Elements2_add_cast + Sum_of_Elements2_add_cast_1;

  Sum_of_Elements3_add_cast <= resize(Sum_of_Elements1_out1, 26);
  Sum_of_Elements3_add_cast_1 <= resize(Sum_of_Elements2_out1, 26);
  Sum_of_Elements3_out1 <= Sum_of_Elements3_add_cast + Sum_of_Elements3_add_cast_1;

  Gain_cast <= resize(Sum_of_Elements3_out1 & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0', 52);
  omega_moving_average <= Gain_cast(49 DOWNTO 26);

  OmegaOut_MA_N4 <= std_logic_vector(omega_moving_average);

END rtl;

